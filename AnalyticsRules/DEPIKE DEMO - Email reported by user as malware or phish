{
    "etag": "\"000021cc-0000-0100-0000-607994e10000\"",
    "kind": "Scheduled",
    "properties": {
        "incidentConfiguration": {
            "createIncident": true,
            "groupingConfiguration": {
                "enabled": true,
                "reopenClosedIncident": false,
                "lookbackDuration": "PT5M",
                "entitiesMatchingMethod": "Custom",
                "groupByEntities": [
                    "MailMessage",
                    "Mailbox"
                ]
            }
        },
        "severity": "Medium",
        "query": "SecurityAlert\r\n| where ProviderName == \"OATP\"\r\n| where AlertName == \"Email reported by user as malware or phish\"\r\n| where not(isempty(Entities))\r\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\r\n| mv-expand parse_json(Entities)\r\n| extend NetworkMessageId_parsed = tostring(parse_json(Entities).NetworkMessageId)\r\n| extend Urls_parsed = parse_json(Entities).Urls\r\n| extend Recipient_parsed = parse_json(Entities).Recipient\r\n| where not(isempty(NetworkMessageId_parsed))\r\n| where not(isempty(Urls_parsed))\r\n| mv-expand Urls_parsed",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "eventGroupingSettings": {
            "aggregationKind": "AlertPerResult"
        },
        "entityMappings": [
            {
                "entityType": "MailMessage",
                "fieldMappings": [
                    {
                        "identifier": "NetworkMessageId",
                        "columnName": "NetworkMessageId_parsed"
                    }
                ]
            },
            {
                "entityType": "URL",
                "fieldMappings": [
                    {
                        "identifier": "Url",
                        "columnName": "Urls_parsed"
                    }
                ]
            },
            {
                "entityType": "Mailbox",
                "fieldMappings": [
                    {
                        "identifier": "MailboxPrimaryAddress",
                        "columnName": "Recipient_parsed"
                    }
                ]
            }
        ],
        "displayName": "DEPIKE DEMO - Email reported by user as malware or phish",
        "enabled": true,
        "description": "This Incident triggers when the alert \"Email reported by user as malware or phish\" comes from Defender for O365.",
        "tactics": [
            "InitialAccess"
        ]
    }
}